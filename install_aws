#######################################################################################
# Before you run this do the following:
#	sudo su
#	vi /etc/sudoers
#   	<scroll down and find the secure_path line>
#   	<hit <i> and insert the following ':/usr/local/bin' at the end of the path>
#   	<hit <esc> and type ':wq!'
#	exit
# This allows 'n' and 'node' to run as sudo
######################################################################################

# update the base system
sudo yum update

# install everything needed to get and compile n
sudo yum install gcc-c++ make
sudo yum install openssl-devel
sudo yum install git

# clone n and install it
cd /root/
git clone git://github.com/visionmedia/n.git
cd n
sudo make install
cd /root/

# Install the latest stable node version using n (npm now comes with node)
# 	To change versions to a specify one type sudo n x.xx.xx
sudo n stable
sudo npm install -g nodemon

#setup an upstart script to launch node-aws-deploy
echo "Creating UpStart Entry"

echo "
#!upstart
description \"Node Deploy\"
author \"none-aws-deploy\"
env APP_PATH=\"/home/ec2-user/node-aws-deploy\"
env ENTRY=\"_start.js\"
start on started mountall
stop on shutdown
respawn
respawn limit 99 5
script
        cd \$APP_PATH
        sudo mkdir \$APP_PATH/logs/
        exec sudo nodemon \$APP_PATH/\$ENTRY >> /\$APP_PATH/logs/log 2>&1
end script

" >> node-aws-deploy.conf
sudo chmod 644 node-aws-deploy.conf
sudo mv node-aws-deploy.conf /etc/init/node-aws-deploy.conf
echo "UpStart Entry Complete..."

# launch the installer for configuring your app
cd /home/ec2-user/node-aws-deploy
sudo npm install -d
sudo node install.js
